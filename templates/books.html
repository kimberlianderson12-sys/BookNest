{% extends "base.html" %}

{% block title %}–ö–Ω–∏–≥–∏ - BookNest{% endblock %}

{% block content %}
<div class="books-page">
    <a href="{{ url_for('dashboard') }}" class="back-link">‚Üê –ù–∞–∑–∞–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h1 style="margin: 0;">–ö–∞—Ç–∞–ª–æ–≥ –∫–Ω–∏–≥</h1>
        {% if session.role == 'admin' %}
        <a href="{{ url_for('admin_add_book') }}" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É</a>
        {% endif %}
    </div>
    
    <div class="search-filters">
        <form method="GET" action="{{ url_for('books') }}" class="search-form">
            <div class="form-row">
                <div class="form-group">
                    <input type="text" name="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ ISBN..." 
                           value="{{ search }}" class="search-input">
                </div>
                <div class="form-group">
                    <select name="genre" id="genre-select" class="form-select">
                        <option value="">–í—Å–µ –∂–∞–Ω—Ä—ã</option>
                        {% for genre in genres %}
                        <option value="{{ genre[0] }}" {% if selected_genre == genre[0]|string %}selected{% endif %}>
                            {{ genre[1] }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <select name="author" id="author-select" class="form-select">
                        <option value="">–í—Å–µ –∞–≤—Ç–æ—Ä—ã</option>
                        {% for author in authors %}
                        <option value="{{ author[0] }}" {% if selected_author == author[0]|string %}selected{% endif %}>
                            {{ author[1] }} {{ author[2] }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group search-buttons">
                    <button type="submit" class="btn btn-primary">–ü–æ–∏—Å–∫</button>
                    <a href="{{ url_for('books') }}" class="btn btn-outline">–°–±—Ä–æ—Å–∏—Ç—å</a>
                </div>
            </div>
        </form>
    </div>
    
    <div class="books-grid">
        {% for book in books %}
        <div class="book-card">
            <div class="book-header">
                <h3>{{ book.title }}</h3>
                {% if book.available_copies > 0 %}
                <span class="badge badge-success">{{ book.available_copies }} –¥–æ—Å—Ç—É–ø–Ω–æ</span>
                {% else %}
                <span class="badge badge-warning">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>
                {% endif %}
            </div>
            <div class="book-content">
                {% if book.image_path %}
                <div class="book-image-container">
                    <img src="{{ url_for('serve_image', filename=book.image_path.split('/')[-1]) }}" 
                         alt="{{ book.title }}" 
                         class="book-image"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div class="book-image-placeholder" style="display: none;">
                        <span>üìö</span>
                    </div>
                </div>
                {% else %}
                <div class="book-image-container">
                    <div class="book-image-placeholder">
                        <span>üìö</span>
                    </div>
                </div>
                {% endif %}
                <div class="book-info">
                    <p><strong>–ê–≤—Ç–æ—Ä:</strong> {{ book.authors }}</p>
                    <p><strong>–ñ–∞–Ω—Ä:</strong> {{ book.genres }}</p>
                    {% if book.isbn %}
                    <p><strong>ISBN:</strong> {{ book.isbn }}</p>
                    {% endif %}
                    {% if book.publication_year %}
                    <p><strong>–ì–æ–¥:</strong> {{ book.publication_year }}</p>
                    {% endif %}
                    {% if book.publisher %}
                    <p><strong>–ò–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ:</strong> {{ book.publisher }}</p>
                    {% endif %}
                    {% if book.description %}
                    <p class="book-description">{{ book.description[:150] }}{% if book.description|length > 150 %}...{% endif %}</p>
                    {% endif %}
                </div>
            </div>
            <div class="book-actions">
                <a href="{{ url_for('book_detail', book_id=book.book_id) }}" class="btn btn-primary">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
            </div>
        </div>
        {% endfor %}
    </div>
    
    {% if not books %}
    <div class="empty-state">
        <p>–ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
    </div>
    {% endif %}
</div>

<script>
(function() {
    const searchForm = document.querySelector('.search-form');
    const searchInput = document.querySelector('.search-input');
    const genreSelect = document.querySelector('select[name="genre"]');
    const authorSelect = document.querySelector('select[name="author"]');
    
    // –§—É–Ω–∫—Ü–∏—è debounce –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    function autoSearch() {
        searchForm.submit();
    }
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º debounce –∫ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∏—Å–∫–∞ (–∑–∞–¥–µ—Ä–∂–∫–∞ 500–º—Å)
    const debouncedSearch = debounce(autoSearch, 500);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ —Ç–µ–∫—Å—Ç–∞
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            debouncedSearch();
        });
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (genreSelect) {
        genreSelect.addEventListener('change', function() {
            searchForm.submit();
        });
    }
    
    if (authorSelect) {
        authorSelect.addEventListener('change', function() {
            searchForm.submit();
        });
    }
})();
</script>
{% endblock %}

